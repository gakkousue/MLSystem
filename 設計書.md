# 実験管理システム 設計書 (Experiment Management System Design Document) Ver 3.2

## 1. システム概要
本システムは、深層学習における実験プロセス（設定、学習、中断・再開、記録）を効率化するためのフレームワークである。
設定の再現性を担保しつつ、バックグラウンドでのジョブ順次実行を容易にすることを目的とする。

### コア・コンセプト
1.  **Deterministic Configuration（設定の決定論的管理）**
    *   設定値（ハイパーパラメータ）が一意であれば、必ず同じ「実験ID（ハッシュ値）」が発行される。
    *   これにより、設定を変更せずに再実行した場合は「続きから再開（Resume）」、設定を変えた場合は「新規実験」として自動的に振り分けられる。
2.  **Adapter Pattern Integration（アダプターによる柔軟な結合）**
    *   **Model（調理）** と **Dataset（素材）** を直接結合せず、**Adapter（橋渡し）** を介在させる。
    *   Adapterがデータの整形ルール（Transform）とモデル構築情報を提供することで、同じデータセットを異なるモデル（画像認識、GNN等）で再利用可能にする。
3.  **Transient Background Execution（一時的なバックグラウンド実行）**
    *   常駐サービス（デーモン）を使用せず、必要な時だけ起動し、ジョブがなくなれば自動終了する「Runner」方式を採用。
4.  **Separation of Concerns（関心の分離）**
    *   **Dataset (`definitions/datasets/`)**: データの保持、分割、Augmentation、生データの可視化。
    *   **Adapter (`definitions/models/.../adapters/`)**: データの整形ルール指定、モデル引数の生成、整形後データの可視化。
    *   **Model (`definitions/models/`)**: ネットワーク構築、学習ループ定義、学習結果の可視化。
    *   **System (`system/`)**: 実行エンジン、GUI、キュー管理。

---

## 2. 機能要件と実現方法

### ① 学習の途中再開 (Auto-Resume)
*   **目的**: 中断（Stop操作やエラー）の後、学習済みエポックから計算を再開したい。
*   **実装**:
    *   設定ハッシュに基づき保存ディレクトリを固定化（`output/experiments/{hash_id}`）。
    *   `system/execute_train.py` 起動時、ディレクトリ内の `last.ckpt` があれば自動的にロードして再開。

### ② Adapterによる動的結合と検証 (Dynamic Binding & Verification)
*   **目的**: データの加工前・加工後・学習結果をそれぞれ確認し、モデルとデータのミスマッチを防ぐ。
*   **実装**:
    *   **Dependency Injection**: Adapterが指定した変換関数（Transform）をDatasetに注入し、Dataset内で実行する。
    *   **多層可視化ジョブ (Multi-Layer Plot Jobs)**:
        *   Dataset, Adapter, Model の各層で `BasePlot` を継承した可視化クラスを定義可能。
        *   これらは独立した「Plotジョブ」としてキューに登録・実行される。
        *   必要に応じて学習済みモデルや、不足している学習処理を自動的に呼び出して（依存解決して）描画を行う。

### ③ GUIモニタリング (Experiment Cockpit)
*   **目的**: 実験の設定、キューへの追加、実行状況の監視、履歴確認を一元管理する。
*   **実装**:
    *   **モジュール化されたパネル構成**: 設定、キュー、履歴を独立したパネルクラスとして実装し、保守性を向上。
    *   **タブ切り替えインターフェース**: 右側パネルを「Job Queue Monitor」と「Experiment History」のタブで分割し、情報の視認性を確保。
    *   **高度なジョブ管理**:
        *   Runnerの起動/停止制御。
        *   ジョブの優先順位変更（Up/Down）、削除、最優先（Top）操作。
    *   **Plot識別機能**: 可視化ジョブ選択時、定義元（Model/Adapter/Dataset）をプレフィックスで明示（例: `[Adapter] TransformedSamples`）。

---

## 3. ディレクトリ構成図

```text
project_root/
│
├── definitions/                  # 【ユーザー実装領域】
│   ├── datasets/
│   │   └── {dataset_name}/       # データセット定義
│   │       ├── config.py         # 設定 (val_ratio, data_dir等)
│   │       ├── datamodule.py     # データ保持・分割・Augmentation
│   │       └── plots.py          # [Plot] 生データの可視化クラス (BasePlot継承)
│   │
│   └── models/
│       └── {model_name}/         # モデル定義
│           ├── config.py         # 設定 (lr, network_params等)
│           ├── model.py          # ネットワーク構築 (Adapterの指示に従う)
│           ├── plots.py          # [Plot] 学習結果の可視化クラス (BasePlot継承)
│           │
│           └── adapters/         # ★新設: アダプター領域
│               └── {adapter_name}/
│                   ├── config.py     # 設定 (対象Dataset指定, リサイズ等)
│                   ├── adapter.py    # 変換ロジック指定 & 引数生成
│                   └── plot.py       # [Plot] 変換後データの可視化クラス (BasePlot継承)
│
├── system/                       # 【システム基盤領域】
│   ├── execute_train.py      # 学習実行エンジン (Hydra + Lightning)
│   ├── execute_plot.py       # 可視化ジョブ実行エンジン
│   ├── gui_start.py          # GUI起動スクリプト (Entry Point)
│   ├── gui/                  # GUI実装パッケージ
│   │   ├── main_window.py        # メインウィンドウ & タブ制御
│   │   └── panels/
│   │       ├── settings_panel.py # 設定 & ジョブ投入
│   │       ├── queue_panel.py    # ジョブ監視 & Runner制御
│   │       └── history_panel.py  # 実験履歴閲覧
│   ├── runner.py             # ジョブ実行ランナー
│   ├── submit.py             # ジョブ登録
│   ├── hashing.py            # 設定ハッシュ計算
│   ├── inspector.py          # クラス定義の探索・収集
│   ├── loader.py             # 実験環境の復元
│   └── utils/
│       ├── base_plot.py      # Plotクラスの基底
│       └── config_base.py    # Configクラスの基底
│
├── output/                       # 【実験結果領域】
│   └── experiments/
│       └── {hash_id}/        # 実験ごとの出力フォルダ
│
└── queue/                        # 【ジョブ管理領域】
    ├── pending/              # 待ち行列
    ├── running/              # 実行中
    ├── finished/
    ├── list.json
    └── failed/
```

---

## 4. データフローと処理プロセス

### A. ジョブ登録フロー (Add to Queue)
1.  **設定選択**: ユーザーがGUIで Model, Adapter, Dataset を選択し、パラメータを調整。
2.  **タスク選択**: "Train" または "Plot" を選択。
    *   Plot選択時は、対象のPlotクラス（Raw Data, Transformed, Resultなど）を指定。
3.  **登録**: 「ADD JOB」押下により、JSONが `queue/pending/` に作成される。

### B. 学習実行フロー (Execution Pipeline: Train)
Runnerが `system/execute_train.py` を呼び出し、以下の順序で処理する。

1.  **Module Load**: 設定に基づき Model, Adapter, Dataset, Config の各モジュールを動的ロード。
2.  **Adapter Binding**: Adapterから `input_transform` を取得し、Datasetを初期化。
3.  **Meta Info Transfer**: Datasetのメタ情報をAdapter経由でModel引数(`model_kwargs`)に変換。
4.  **Training**: PyTorch Lightning Trainerにより学習を実行し、チェックポイントを保存。

### C. 可視化実行フロー (Execution Pipeline: Plot)
Runnerが `system/execute_plot.py` を呼び出す。

1.  **Restore**: 実験ID(Hash)から設定とモジュールを復元(`Loader`)。
2.  **Resolve Dependency**: 学習済みモデルが必要なPlotの場合、チェックポイントを確認。
    *   存在しない場合、自動的に `execute_train.py` をサブプロセスで呼び出し、学習を完了させてから描画に戻る。
3.  **Plotting**: `BasePlot.execute()` メソッドが実行され、結果画像が実験フォルダに保存される。

---

## 5. 開発者向けガイド

| 目的          | 編集ファイル                                      | 内容                                                    |
| :---------- | :------------------------------------------ | :---------------------------------------------------- |
| **新規モデル追加** | `definitions/models/{name}/`                | `model.py` (構造), `config.py` (学習率等), `adapters/` を作成。 |
| **新規データ対応** | `definitions/models/{name}/adapters/{new}/` | データセット形式に合わせるための変換ロジック (`adapter.py`) と設定を作成。         |
| **可視化の追加**  | 各階層の `plots.py` / `plot.py`                 | `BasePlot` を継承したクラスを作成し、`execute` メソッドを実装。            |
| **パラメータ追加** | 各 `config.py`                               | `conf_field` を定義。GUI・ハッシュ計算に自動反映される。                  |