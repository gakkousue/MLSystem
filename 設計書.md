# 実験管理システム 設計書 (Experiment Management System Design Document) Ver 4.2

## 1. システム概要
本システムは、深層学習における実験プロセス（設定、学習、中断・再開、記録）を効率化するためのフレームワークである。
設定の再現性を担保しつつ、バックグラウンドでのジョブ順次実行を容易にすることを目的とする。

### コア・コンセプト
1.  **Deterministic Configuration（設定の決定論的管理）**
    *   設定値（ハイパーパラメータ）が一意であれば、必ず同じ「実験ID（ハッシュ値）」が発行される。
    *   設定を変更せずに再実行した場合は「続きから再開（Resume）」、設定を変えた場合は「新規実験」として自動的に振り分けられる。
2.  **Unified Parameter Injection（設定の統合注入）**
    *   Common, Dataset, Adapter, Model の設定を全てマージした単一のパラメータ辞書を各コンポーネントに渡す。
    *   これにより、ModelがDatasetの設定を知る、あるいはその逆といった柔軟なパラメータ参照が可能になる。
3.  **Adapter Pattern Integration（アダプターによる柔軟な結合）**
    *   **Model（調理）** と **Dataset（素材）** を直接結合せず、**Adapter（橋渡し）** を介在させる。
    *   Adapterがデータの整形ルール（Transform）とモデル構築情報を提供することで、同じデータセットを異なるモデル（画像認識、GNN等）で再利用可能にする。
4.  **Transient Background Execution（一時的なバックグラウンド実行）**
    *   常駐サービスを使用せず、必要な時だけ起動し、ジョブがなくなれば自動終了する「Runner」方式を採用。
5.  **Explicit Registry Management（明示的なレジストリ管理）**
    *   全てのModel, Adapter, Datasetのパスは `configs/registry.json` で一元管理し、システムはこれを参照してロードを行う。
6.  **Environment Config Manager（環境依存の分離）**
    *   環境変数 `MLSYSTEM_CONFIG` を介して設定ファイル（`env_config.json`）を読み込むことで、実行環境（ディレクトリ構成）への依存を排除する。
7.  **Sub-Module Plotting (サブモジュール可視化)**
    *   モデル全体だけでなく、モデル内の特定のコンポーネント（サブモジュール）に対しても個別にPlot実行が可能。
8.  **Command-Line Interface (CLI)**
    *   過去の実験設定ファイル (`config.json` や `job.json`) を元に、対話形式で新たな学習・可視化ジョブを投入できるCLIツールを提供する。

---

## 2. 機能要件と実現方法

### ① 環境設定の動的解決 (Dynamic Environment Resolution)
*   **目的**: カレントディレクトリに依存せず、任意の場所からシステムを実行可能にする。また、複数のプロジェクト（設定）を環境変数一つで切り替え可能にする。
*   **実装**:
    *   `MLSystem/utils/env_manager.py`: シングルトンクラス `EnvManager` が環境変数 `MLSYSTEM_CONFIG` を読み取り、各ディレクトリパス（`common_dir`, `output_dir`, `queue_dir`, `registry_path`）を提供する。
    *   各コンポーネントは `EnvManager` 経由でパスや設定を取得するため、ハードコードされたパスは排除される。

### ② 実験環境の構築 (Experiment Builder)
*   **目的**: 設定の解釈、クラスのロード、パラメータのマージ、インスタンス化という複雑な初期化プロセスを分離し、学習時・推論時で共通化する。
*   **実装**:
    *   `MLSystem/builder.py`: `ExperimentBuilder` クラスがHydraの設定(`cfg`)を受け取り、`Registry`を用いてクラスを取得。
    *   **軽量ハッシュ計算**: `get_hash_only()` メソッドを提供し、モデルのインスタンス化などの重い処理を行わずにハッシュIDと設定差分のみを計算可能にする。これはGUIやCLIでのプレビューに使われる。
    *   **Flat Parameter Merging**: `Common` < `Dataset` < `Adapter` < `Model` の優先順位でパラメータ辞書を統合し、`all_params`を作成。
    *   `ExperimentContext` オブジェクトを通じて、構築されたモデルやデータモジュール、ハッシュID、**完全な設定情報**などを一括で受け渡す。
    *   **Registry Inheritance & Composition**: `parent` フィールドによる設定の継承（再帰的マージ）と、`components` フィールドによるサブモジュールの包含をサポート。
    *   **Config Hash Control**: `conf_field` に `excludes` パラメータを指定することで、特定のキーをハッシュ計算から除外し、実験IDを変えずに設定を変更可能にする（例: ログ出力の制御フラグなど）。

### ③ 学習の途中再開 (Auto-Resume) & チェックポイント管理
*   **目的**: 中断後、学習済みエポックから計算を再開する。また、完了済みの実験に対してエポック数を追加して「追学習」を行いたい。
*   **実装**:
    *   `MLSystem/checkpoint_manager.py`: チェックポイントの検索、一覧取得、再開パス決定、Callback作成のロジックを集約。
    *   `MLSystem/execute_train.py` は起動時に既存のチェックポイントが持つエポック数と、設定された `max_epochs` を比較する。
    *   不足分があれば自動的に追学習を行い、完了済みであれば即時正常終了する。これにより、`done` ファイルのような状態管理フラグは不要となる。

### ④ Adapterによる動的結合と検証 (Dynamic Binding & Verification)
*   **実装**:
    *   **Dependency Injection**: Adapterが指定した変換関数（Transform）をDatasetに注入し、Dataset内で実行する。
    *   **多層可視化ジョブ (Multi-Layer Plot Jobs)**: Dataset, Adapter, Model の各層で `BasePlot` を継承した可視化クラスを定義可能。

### ⑤ GUIモニタリング (Experiment Cockpit)
*   **実装**:
    *   **モジュール化されたパネル構成**: 設定、キュー、履歴を独立したパネルクラスとして実装。
    *   **ハッシュ計算の委譲**: GUIはパラメータ変更時にリアルタイムでハッシュIDをプレビュー表示するが、その計算ロジックは `MLSystem/submit.py` の `calculate_hash` 関数を呼び出す。ロジックを一元化し、GUIは表示に専念する。

### ⑥ CLIによるジョブ投入 (CLI Job Submission)
*   **目的**: GUIを使わずに、コマンドラインから対話形式でジョブを投入する。
*   **実装**:
    *   `MLSystem/submit_cli.py`: `python -m MLsystem.submit_cli <path/to/config.json>` のように実行。
    *   既存の `config.json` や `job.json` を読み込み、設定を再現。
    *   Train/Plotのタスク選択、Plot対象の選択、追加のパラメータ上書きなどを対話形式で行う。
    *   最終的なジョブ投入は `MLSystem/submit.py` を呼び出す。

---

## 3. ディレクトリ構成図

```text
project_root/
│
├── configs/
│   ├── config.yaml           # Hydra基本設定
│   └── registry.json         # パス管理レジストリ
│
├── definitions/                  # 【ユーザー実装領域】
│   ├── datasets/
│   │   └── {dataset_name}/       # データセット定義
│   │       ├── config.py         # 設定
│   │       ├── datamodule.py     # データ保持・分割・Augmentation
│   │       └── plots.py          # [Plot] 生データの可視化
│   │
│   └── models/
│       └── {model_name}/         # モデル定義
│           ├── config.py         # 設定
│           ├── model.py          # ネットワーク構築
│           ├── plots.py          # [Plot] 学習結果の可視化
│           │
│           └── adapters/         # アダプター領域
│               └── {adapter_name}/
│                   ├── config.py     # 設定
│                   ├── adapter.py    # 変換ロジック指定 & 引数生成
│                   └── plot.py       # [Plot] 変換後データの可視化
│
├── MLSystem/                       # 【システム基盤領域】(pip install -e .)
│   ├── pyproject.toml
│   ├── __init__.py
│   ├── execute_train.py
│   ├── execute_plot.py
│   ├── submit_cli.py         # [追加] CLIツール
│   ├── builder.py
│   ├── checkpoint_manager.py
│   ├── callbacks.py
│   ├── loader.py
│   ├── registry.py
│   ├── runner.py
│   ├── submit.py
│   ├── hashing.py
│   ├── inspector.py
│   ├── gui_start.py
│   ├── gui/
│   └── utils/
│       ├── base_plot.py
│       ├── config_base.py
│       ├── env_manager.py
│       └── hydra_helper.py   # [追加] Hydra関連ヘルパー
│
├── output/                       # 【実験結果領域】
│   └── experiments/
│       └── {hash_id}/        # 実験ごとの出力フォルダ
│           ├── config.json         # [追加] 全設定ファイル
│           ├── config_diff.json
│           └── ... (ログ、チェックポイント等)
│
└── queue/                        # 【ジョブ管理領域】
```

---

## 4. データフローと処理プロセス

### A. ジョブ登録フロー (Add to Queue)
1.  ユーザーが**GUI**または**CLI (`submit_cli.py`)**でパラメータを指定・確認し、ジョブ投入を指示。
2.  `MLSystem/submit.py` の `add_job` 関数が呼び出される。
3.  `add_job` は内部で `calculate_hash` を実行し、Hydra引数から**ハッシュIDを計算**する。
4.  計算されたハッシュIDを含むジョブ定義JSONが `queue/pending/` に保存される。

### B. 学習実行フロー (Execution Pipeline: Train)
Runnerが `python -m MLsystem.execute_train` を呼び出す。

1.  **Experiment Build**: `ExperimentBuilder` を初期化し、`build()` を実行。
    *   `Registry` から定義ファイルをロード。
    *   パラメータを統合し、ハッシュを計算。
    *   `DataModule`, `Model` をインスタンス化。
2.  **設定保存**: `execute_train.py` が `output/experiments/{hash_id}/` ディレクトリを作成し、以下の2つのファイルを保存する。
    *   `config_diff.json`: デフォルト値との差分のみ（再現用）。
    *   `config.json`: **全てのパラメータが解決された完全な設定ファイル**（可読性・CLIでの再利用）。
3.  **Checkpoint Preparation**: `CheckpointManager` が再開可能なチェックポイントを探索。
4.  **Training**: PyTorch Lightning Trainerにより学習を実行。

### C. 可視化実行フロー (Execution Pipeline: Plot)
Runnerが `python -m MLsystem.execute_plot` を呼び出す。

1.  **Restore**: `Loader` が実験ID(Hash)から設定を復元。
    *   内部で `Builder` と同様のパラメータ統合ロジックを使用し、環境を再現。
2.  **Resolve Dependency**: `CheckpointManager` を通じてモデルの重みをロード。
    *   **注意**: 学習が未完了の場合、エラー終了する（自動学習トリガーは廃止）。事前に学習ジョブの完了が必要。
3.  **Target Injection**: 指定されたターゲット（メインモデルまたはサブモジュール）をPlotインスタンスに注入。
4.  **Plotting**: `BasePlot.execute()` メソッドにより描画。

---

## 5. 開発者向けガイド

| 目的          | 編集ファイル                                      | 内容                                                    |
| :---------- | :------------------------------------------ | :---------------------------------------------------- |
| **新規モデル追加** | `definitions/models/{name}/` + `registry.json` | ファイル作成後、**必ず `configs/registry.json` にパスを登録する。** `config.py` は `dataclass` で記述する。 |
| **新規データ対応** | `definitions/models/{name}/adapters/{new}/` + `registry.json` | 変換ロジック作成後、`registry.json` の該当モデル内にAdapterを登録する。         |
| **可視化の追加**  | 各階層の `plots.py` / `plot.py`                 | `BasePlot` を継承したクラスを作成。                                    |
| **パラメータ追加** | 各 `config.py`                               | `dataclass` 内にフィールドを定義。`excludes=["key"]` でハッシュ除外指定が可能。 |
| **モデル継承**   | `registry.json`                             | `parent` フィールドに親モデル名を指定すると設定が継承・マージされる。       |
| **モジュール包含** | `registry.json`                             | `components` フィールドに `{ "attr_name": "ModelName" }` を定義。      |

---

## 6. 付録：インストールと実行方法

### パッケージのインストール
プロジェクトルートで以下のコマンドを実行し、`MLsystem` を編集可能モードでインストールします。
```bash
pip install -e ./MLSystem
```

### システムの起動 (GUI)
```bash
python -m MLSystem.gui_start
```

### 環境設定 (必須)
実行前に環境変数 `MLSYSTEM_CONFIG` に `env_config.json` への絶対パスを設定してください。

**PowerShell:**
```powershell
$env:MLSYSTEM_CONFIG = "C:\Absolute\Path\To\env_config.json"
```

**env_config.json の形式:**
```json
{
    "common_dir":      "/absolute/path/to/common",
    "output_dir":      "/absolute/path/to/output",
    "queue_dir":       "/absolute/path/to/queue",
    "registry_path":   "/absolute/path/to/configs/registry.json"
}
```

### CLIからのジョブ投入
過去の実験で生成された `config.json` や `job.json` を使って、対話形式でジョブを再投入できます。
```bash
python -m MLsystem.submit_cli output/experiments/{hash_id}/config.json
```
実行すると、タスク（Train/Plot）の選択や、パラメータの追加上書きが可能です。

### ジョブの実行
ジョブは Runner によって自動的に実行されますが、手動で Runner を起動する場合は以下を実行します。
```bash
python -m MLsystem.runner
```