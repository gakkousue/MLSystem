# 実験管理システム 設計書 (Experiment Management System Design Document) Ver 4.0

## 1. システム概要
本システムは、深層学習における実験プロセス（設定、学習、中断・再開、記録）を効率化するためのフレームワークである。
設定の再現性を担保しつつ、バックグラウンドでのジョブ順次実行を容易にすることを目的とする。

### コア・コンセプト
1.  **Deterministic Configuration（設定の決定論的管理）**
    *   設定値（ハイパーパラメータ）が一意であれば、必ず同じ「実験ID（ハッシュ値）」が発行される。
    *   設定を変更せずに再実行した場合は「続きから再開（Resume）」、設定を変えた場合は「新規実験」として自動的に振り分けられる。
2.  **Unified Parameter Injection（設定の統合注入）**
    *   Common, Dataset, Adapter, Model の設定を全てマージした単一のパラメータ辞書を各コンポーネントに渡す。
    *   これにより、ModelがDatasetの設定を知る、あるいはその逆といった柔軟なパラメータ参照が可能になる。
3.  **Adapter Pattern Integration（アダプターによる柔軟な結合）**
    *   **Model（調理）** と **Dataset（素材）** を直接結合せず、**Adapter（橋渡し）** を介在させる。
    *   Adapterがデータの整形ルール（Transform）とモデル構築情報を提供することで、同じデータセットを異なるモデル（画像認識、GNN等）で再利用可能にする。
4.  **Transient Background Execution（一時的なバックグラウンド実行）**
    *   常駐サービスを使用せず、必要な時だけ起動し、ジョブがなくなれば自動終了する「Runner」方式を採用。
5.  **Explicit Registry Management（明示的なレジストリ管理）**
    *   全てのModel, Adapter, Datasetのパスは `configs/registry.json` で一元管理し、システムはこれを参照してロードを行う。

---

## 2. 機能要件と実現方法

### ① 実験環境の構築 (Experiment Builder)
*   **目的**: 設定の解釈、クラスのロード、パラメータのマージ、インスタンス化という複雑な初期化プロセスを分離し、学習時・推論時で共通化する。
*   **実装**:
    *   `MLSystem/builder.py`: `ExperimentBuilder` クラスがHydraの設定(`cfg`)を受け取り、`Registry`を用いてクラスを取得。
    *   **Flat Parameter Merging**: `Common` < `Dataset` < `Adapter` < `Model` の優先順位でパラメータ辞書を統合し、`all_params`を作成。
    *   `ExperimentContext` オブジェクトを通じて、構築されたモデルやデータモジュール、ハッシュIDなどを一括で受け渡す。

### ② 学習の途中再開 (Auto-Resume) & チェックポイント管理
*   **目的**: 中断後、学習済みエポックから計算を再開する。また、完了済みの実験に対してエポック数を追加して「追学習」を行いたい。
*   **実装**:
    *   `MLSystem/checkpoint_manager.py`: チェックポイントの検索、一覧取得、再開パス決定、Callback作成のロジックを集約。
    *   `MLSystem/execute_train.py` は起動時に既存のチェックポイントが持つエポック数と、設定された `max_epochs` を比較する。
    *   不足分があれば自動的に追学習を行い、完了済みであれば即時正常終了する。これにより、`done` ファイルのような状態管理フラグは不要となる。

### ③ Adapterによる動的結合と検証 (Dynamic Binding & Verification)
*   **実装**:
    *   **Dependency Injection**: Adapterが指定した変換関数（Transform）をDatasetに注入し、Dataset内で実行する。
    *   **多層可視化ジョブ (Multi-Layer Plot Jobs)**: Dataset, Adapter, Model の各層で `BasePlot` を継承した可視化クラスを定義可能。

### ④ GUIモニタリング (Experiment Cockpit)
*   **実装**:
    *   **モジュール化されたパネル構成**: 設定、キュー、履歴を独立したパネルクラスとして実装。
    *   **高度なジョブ管理**: Runner制御、優先順位変更、ログ確認。
    *   **詳細ログ記録**: `JobLoggingCallback` により、学習の進捗（エポックごとのLoss/Accuracy）も `queue/logs/` に記録され、リアルタイムでの状況確認が可能。

---

## 3. ディレクトリ構成図

```text
project_root/
│
├── configs/
│   ├── config.yaml           # Hydra基本設定
│   └── registry.json         # パス管理レジストリ
│
├── definitions/                  # 【ユーザー実装領域】
│   ├── datasets/
│   │   └── {dataset_name}/       # データセット定義
│   │       ├── config.py         # 設定
│   │       ├── datamodule.py     # データ保持・分割・Augmentation
│   │       └── plots.py          # [Plot] 生データの可視化
│   │
│   └── models/
│       └── {model_name}/         # モデル定義
│           ├── config.py         # 設定
│           ├── model.py          # ネットワーク構築
│           ├── plots.py          # [Plot] 学習結果の可視化
│           │
│           └── adapters/         # アダプター領域
│               └── {adapter_name}/
│                   ├── config.py     # 設定
│                   ├── adapter.py    # 変換ロジック指定 & 引数生成
│                   └── plot.py       # [Plot] 変換後データの可視化
│
├── MLSystem/                       # 【システム基盤領域】(pip install -e .)
│   ├── pyproject.toml        # パッケージ設定
│   ├── __init__.py           # パス解決（カレントディレクトリの追加）
│   ├── execute_train.py      # 学習実行エントリポイント
│   ├── execute_plot.py       # 可視化ジョブ実行エントリポイント
│   ├── builder.py            # 実験環境構築 (Builderパターン)
│   ├── checkpoint_manager.py # チェックポイント管理
│   ├── callbacks.py          # ログ出力などのカスタムコールバック
│   ├── loader.py             # 実験の復元 (分析用)
│   ├── registry.py           # レジストリ管理・モジュールロード
│   ├── runner.py             # ジョブ実行ランナー
│   ├── submit.py             # ジョブ登録
│   ├── hashing.py            # 設定ハッシュ計算
│   ├── inspector.py          # クラス定義の探索・収集
│   ├── gui_start.py          # GUI起動スクリプト
│   ├── gui/                  # GUI実装パッケージ
│   └── utils/
│       ├── base_plot.py      # Plotクラスの基底
│       └── config_base.py    # Configクラスの基底
│
├── output/                       # 【実験結果領域】
│   └── experiments/
│       └── {hash_id}/        # 実験ごとの出力フォルダ
│
└── queue/                        # 【ジョブ管理領域】
```

---

## 4. データフローと処理プロセス

### A. ジョブ登録フロー (Add to Queue)
1.  ユーザーがGUIでパラメータを調整し「ADD JOB」。
2.  `MLSystem/submit.py` がJSONを作成し、`queue/pending/` に保存。

### B. 学習実行フロー (Execution Pipeline: Train)
Runnerが `python -m MLsystem.execute_train` を呼び出す。

1.  **Experiment Build**: `ExperimentBuilder` を初期化し、`build()` を実行。
    *   `Registry` から定義ファイルをロード。
    *   パラメータを統合（Common, Dataset, Adapter, Model）。
    *   ハッシュを計算し、`DataModule`, `Model` をインスタンス化。
2.  **Checkpoint Preparation**: `CheckpointManager` が再開可能なチェックポイント（`last.ckpt`等）を探索。
3.  **Training**: PyTorch Lightning Trainerにより学習を実行。正常終了すれば終了コード0が返り、Runnerはこれを検知してジョブを `finished` 状態に遷移させる。

### C. 可視化実行フロー (Execution Pipeline: Plot)
Runnerが `python -m MLsystem.execute_plot` を呼び出す。

1.  **Restore**: `Loader` が実験ID(Hash)から設定を復元。
    *   内部で `Builder` と同様のパラメータ統合ロジックを使用し、環境を再現。
2.  **Resolve Dependency**: `CheckpointManager` を通じてモデルの重みをロード。
    *   チェックポイントがない場合、自動的に学習を実行。
3.  **Plotting**: `BasePlot.execute()` メソッドにより描画。

---

## 5. 開発者向けガイド

| 目的          | 編集ファイル                                      | 内容                                                    |
| :---------- | :------------------------------------------ | :---------------------------------------------------- |
| **新規モデル追加** | `definitions/models/{name}/` + `registry.json` | ファイル作成後、**必ず `configs/registry.json` にパスを登録する。** `config.py` は `dataclass` で記述する。 |
| **新規データ対応** | `definitions/models/{name}/adapters/{new}/` + `registry.json` | 変換ロジック作成後、`registry.json` の該当モデル内にAdapterを登録する。         |
| **可視化の追加**  | 各階層の `plots.py` / `plot.py`                 | `BasePlot` を継承したクラスを作成。                                    |
| **パラメータ追加** | 各 `config.py`                               | `dataclass` 内にフィールドを定義。自動的に統合され `all_params` に含まれる。         |

---

## 6. 付録：インストールと実行方法

### パッケージのインストール
プロジェクトルートで以下のコマンドを実行し、`MLsystem` を編集可能モードでインストールします。
```bash
pip install -e ./MLSystem
```

### システムの起動 (GUI)
```bash
python -m MLSystem.gui_start
```

### ジョブの実行
ジョブは Runner によって自動的に実行されますが、手動で Runner を起動する場合は以下を実行します。
```bash
python -m MLsystem.runner
```
