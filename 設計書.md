# MLSystem プロジェクト設計書

本プロジェクトは、深層学習の実験管理を効率化するための複数のパッケージおよびコンポーネントで構成されています。

## パッケージ別設計書

### 1. [MLSystem (Core Framework)](設計書_MLSystem.md)
実験のメインロジック、Hydra を用いた設定管理、学習および可視化の実行スクリプト。

### 2. [PyPathManager](設計書_PyPathManager.md)
環境変数 `PYPATH_CONFIG` を用いた動的なパス管理ユーティリティ。

### 3. [SimpleTaskQueue](設計書_SimpleTaskQueue.md)
ジョブのキューイングとバックグラウンド実行を担う軽量システム。

---

## 全体ディレクトリ構成
```text
project_root/
├── MLSystem/           # コアフレームワーク
├── PyPathManager/      # パス管理 (独立)
├── SimpleTaskQueue/    # ジョブキュー (独立)
├── definitions/        # ユーザー定義 (Dataset/Model)
├── configs/            # プロジェクト設定 (Hydra)
├── outputs/            # 実験出力
├── experiments/        # 実験リンク
└── queue/              # ジョブ管理フォルダ
```

---

## 3. ディレクトリ構成図

```text
project_root/
│
├── PyPathManager/            # [独立] パス管理ライブラリ
├── SimpleTaskQueue/          # [独立] ジョブ管理ライブラリ
│
├── configs/
│   ├── config.yaml           # Hydraルート設定 (defaults list)
│   ├── dataset/
│   │   └── mnist.yaml        # データセット設定
│   ├── model/
│   │   └── resnet.yaml       # モデル設定
│   └── hydra/                # Hydra自体の設定
│
├── definitions/              # 【ユーザー実装領域】
│   ├── datasets/
│   │   └── {name}/
│   │       ├── loaders/      # 生データ読み込みロジック
│   │       ├── datamodule.py # LightningDataModule
│   │       └── default.yaml  # デフォルトHydra設定(_target_)
│   │
│   └── models/
│       └── {name}/
│           ├── model.py      # LightningModule
│           └── default.yaml  # デフォルトHydra設定(_target_)
│
├── MLSystem/                 # 【実行スクリプト】
│   ├── execute_train.py
│   ├── execute_plot.py
│   └── ...
│
├── outputs/                  # Hydra出力 (outputs/date/time)
├── experiments/              # 実験名ごとのリンク (experiments/exp1/latest -> outputs/...)
│
└── queue/                    # ジョブキュー
    ├── pending/
    ├── finished/
    └── failed/
```

---

## 4. 開発者向けガイド

### 新規コンポーネントの追加
1.  **データセット**: `definitions/datasets/{name}/` を作成。
    *   `loaders/` に読み込み処理を実装。
    *   `datamodule.py` で `LightningDataModule` を実装 (`__init__` で loader を受け取る)。
    *   `default.yaml` に `_target_` とデフォルト引数を記述。
    *   `configs/dataset/{name}.yaml` にシンボリックリンクまたは継承設定を作成。

2.  **モデル**: `definitions/models/{name}/` を作成。
    *   `model.py` で `LightningModule` を実装 (`__init__` でパラメータを明示的に受け取る)。
    *   `default.yaml` に `_target_` とデフォルト引数を記述。
    *   `configs/model/{name}.yaml` にシンボリックリンクまたは継承設定を作成。

### 実行方法

**学習**
```bash
# 基本実行
python MLSystem/execute_train.py dataset=mnist model=resnet exp_name=test01

# パラメータ上書き
python MLSystem/execute_train.py model.lr=0.01 max_epochs=5
```

**再開 / プロット**
```bash
# 再開（チェックポイントロード）
python MLSystem/execute_train.py source_run_dir=/path/to/prev_run

# プロット（実験結果の可視化）
python MLSystem/execute_plot.py source_run_dir=/path/to/prev_run
```
